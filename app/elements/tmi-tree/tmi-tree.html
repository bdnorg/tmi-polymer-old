<link rel="stylesheet" href="tmi-tree.css">


<!-- chrome.windows.getAll() data in window.testWins -->
<script src="../../test/chrome.windows.test.data.js"></script>
<script>
  console.log("window.testWins: ", window.testWins);
</script>

<dom-module id="tmi-win-display">
  <template>
    [<iron-icon icon="receipt"
                style="height: 16px; width: 16px;"></iron-icon>
     <span>[[win.tabs.0.title]]</span>]
  </template>
</dom-module>
<script>
  (function () {
    Polymer({
      is: "tmi-win-display",
      properties: {
        win: {
          type: "object",
        },
      },
      ready: function() {
      },
    });
  })();
</script>

<!--
    <core-tooltip label="I'm a tooltip" position="bottom ">
      <div tip>
        <tmi-win-display id="{{win.id}}" win="{{win}}"></tmi-win-display>
      </div>
    </core-tooltip>

      <div class="clip {{ {pointer: win.id == pointer} | tokenList}}">
      </div>
-->

<dom-module id="tmi-window">
  <style>
   .tabBlock{
     margin-left: 2em;
     white-space: nowrap;
     overflow: hidden;
     background-color: white;
   }
   .ind {margin-left: 2em;}
   .clip {white-space: nowrap; overflow: hidden;}
   :host {
     display: block;
     border: solid white 1px;
   }
   :host([pointer]) {
     background-color: pink;
     border: solid red 1px;
   }
   .collapse-content {
     padding: 5px;
     border: 1px solid #dedede;
  }
  </style>
  <template>
<!--
    <div class="clip {{ {pointer: win.id == pointer} | tokenList}}">
-->
    <div class="clip"> <div id="pnode">
      <span on-click="toggle">
        <iron-icon icon="expand-more"
                   style="height: 16px; width: 16px;"></iron-icon>
      </span>
      <input type="checkbox" name="winCheck" value="{{win.id}}">
      (<span>{{win.win.tabs.length}}</span>)
        <tmi-win-display win="{{win.win}}"></tmi-win-display>
        - <span>{{win.id}}</span>
    </div></div>

    <iron-collapse id="collapse" class="">
      <div class="collapse-content tabBlock ind clip">
        <template is="dom-repeat" items="{{win.win.tabs}}" as="tab">
          <tmi-tab tab="{{tab}}" id="{{tab.id}}"
                   class="node"></tmi-tab>
        </template>
      </div>
    </iron-collapse>
  </template>
</dom-module>
<script>
  (function () {
    Polymer({
      is: "tmi-window",
      properties: {
        win: {
          type: "object",
        },
        pointer: {
          type: Boolean,
          notify: true,
        }
      },
//      observers: [
//        'pointerChange(win.pointer)',
//      ],
      pointerChange: function(){
        console.log('pointerChange');
        if (this.win.pointer){
//          this.$.pnode.classList.add('pointer')
          this.classList.add('pointer')
        } else {
//          this.$.pnode.classList.remove('pointer')
          this.classList.remove('pointer')
        }
      },

//      collapse: function(event, detail, sender) {
      toggle: function() {
        this.$.collapse.toggle();
      },
    });
  })();
</script>

<dom-module id="tmi-tab">
  <style>
    :host {display: block;}
    :host([pointer]) {background-color: pink;}
    .ind {margin-left: 1.5em;
    .clip {white-space: nowrap; overflow: hidden;}
    }
  </style>
  <template>
    <div>
      <input type="checkbox" name="tabCheck" value="{{tab.id}}">
      <span>
         <iron-icon icon="receipt"
                    style="height: 16px; width: 16px;"></iron-icon>
      </span>
      <span>{{tab.title}}</span>
    </div>
  </template>
</dom-module>
<script>
  (function () {
    Polymer({
      is: "tmi-tab",
      properties: {
        tab: {
          type: "object",
        },
      },
    });
  })();
</script>

<dom-module id="tmi-tree">
  <style>
    .pointer {background-color: pink;}
    .ind {margin-left: 1.5em;}
    .clip {white-space: nowrap; overflow: hidden;}
  </style>
  <template>
    Tree
    <div class="ind">
      <template is="dom-repeat" items="{{tree}}" as="win">
        <tmi-window win="[[win]]" id="[[win.id]]" class="node"
                    pointer$="{{win.pointer}}"></tmi-window>
      </template>
    </div>
  </template>
</dom-module>
  <script>
    (function () {
      Polymer({
        is: "tmi-tree",
        properties: {
          wins:{
            type: Array,
            notify: true,
          }
        },
        ready: function() {
          this.tree = this.genTestTree();
          this.pointer = this.tree[0];
//          this.querySelector('::shadow tmi-window') .classList.add('pointer')

          /*
          var app = document.querySelector('#' + this.appId);
          this.keyMap = app.tt;
          app.loadKeyMap(this,[])
          */
        },

        test: function(t){
          console.log(t)
        },
        getFirstEl: function(){
//          return this.querySelector('tmi-window')
          return document.querySelector('tmi-tree::shadow tmi-window::shadow tmi-win-display::shadow span').innerText;
        },

        // Tree helpers
        genTestTree: function(t){
          this.wins = window.testWins;
          var tree = [];
          for (win of this.wins) {
            tree.push({win: win, id: 'id-' + win.id})
          }
          tree[0].pointer = true;
          return tree;
        },
        mvPointer: function(node){
          this.set('pointer.pointer', false);
          this.pointer=node;
          this.set('pointer.pointer', true);
        },
        getVisibleEls: function(){
          return this.shadowRoot.querySelectorAll('.node, ::shadow .iron-collapse-opened .node')
        },
        getPointer: function(){
          return this.shadowRoot.querySelector('.node[pointer], ::shadow .iron-collapse-opened .node[pointer]')

/*
          var elList = this.getVisibleEls();
          for (var i = 0; i < elList.length; i++) {
            if (elList[i].hasAttribute('pointer')){
              return elList[i];
            }
          };
*/
        },
        getPointerIndex: function(elList){
          for (var i = 0; i < elList.length; i++) {
            if (elList[i].hasAttribute('pointer')){
              return i;
            }
          };
        },

        //Tree movement
        down: function(){
          var elList = this.getVisibleEls();
          var i = this.getPointerIndex(elList);
          elList[i].removeAttribute('pointer');
          elList[i+1].setAttribute('pointer', '');
//          this.pointerEl = app.tree.shadowRoot.querySelector('#id-565::shadow .iron-collapse-opened tmi-tab, #id-565 + tmi-window');
        },
        up: function(){
          var elList = this.getVisibleEls();
          var i = this.getPointerIndex(elList);
          elList[i].removeAttribute('pointer');
          elList[i-1].setAttribute('pointer', '');
        },
        right: function(){
//todo getPointerWin
          this.getPointer().toggle();
        },
        left: function(){
          this.getPointer().toggle();
        },
        downTen: function(){},
        upTen: function(){},
        moveTop: function(){},
        moveBottom: function(){},

        //nav wintabs
//        browser.focusWin: function(win){},
//        browser.focusTab: function(tab){},
        pin: function(){},
        searchMode: function(){},
        clearInput: function(){},
        goMark: function(){},
        mark: function(){},

        //manage wintabs
        mark: function(){},
        mark: function(){},
        putAfterTab: function(tab){},
        putEndOfWin: function(win){},
        putNew: function(){},
        name: function(){},
        toSave: function(){},
        close: function(){},
//        delete: function(){},

        //Freezing
        makeFreezer: function(closed){},
//        browser.bmFreeze: function(win){},
//        browser.freezeAll: function(key){},
//        browser.freezeTab: function(tab){},


        //Popup manage
//        break: function(){},
        quit: function(){},
        refresh: function(){},
//        getPointer: function(){return {id: 9999, type: 'win'}},
//        getPointer: function(){return this.pointer; },
        getPointerWin: function(){return {id: 9998, type: 'win'}},
        injectPointer: function(func) {
          return function(){ func(this.getPointer()); };
        },
        injectPointerWin: function(func) {
          return function(){ func(this.getPointerWin()); };
        },


      });
    })();
  </script>


<dom-module id="tmi-browser">
</dom-module>
<script>
  (function () {
    Polymer({
      is: "tmi-browser",
      properties: {
        wins: {
          type: "object",
        },
      },
    });
  })();
</script>
